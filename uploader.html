<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smartways Excel Data Importer for Supabase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 26px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .section h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #1976D2;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #388E3C;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .btn-warning {
            background: #FF9800;
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            background: #F57C00;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #d32f2f;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .file-input-wrapper {
            margin: 20px 0;
            padding: 30px;
            border: 2px dashed #2196F3;
            border-radius: 10px;
            text-align: center;
            background: #f0f8ff;
            transition: all 0.3s ease;
        }
        
        .file-input-wrapper:hover {
            border-color: #1976D2;
            background: #e3f2fd;
        }
        
        .file-input-wrapper.has-file {
            border-style: solid;
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .file-input {
            display: none;
        }
        
        .status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196F3;
        }
        
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4CAF50;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        
        .status.warning {
            background: #fff3e0;
            color: #ef6c00;
            border-left: 4px solid #ff9800;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2196F3, #21CBF3);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .log-area {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            line-height: 1.5;
        }
        
        .log-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .log-area::-webkit-scrollbar-track {
            background: #37474f;
        }
        
        .log-area::-webkit-scrollbar-thumb {
            background: #546e7a;
            border-radius: 4px;
        }
        
        .config-form {
            display: grid;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .preview-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .preview-table th {
            background: #2196F3;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .preview-table td {
            padding: 8px 10px;
            border: 1px solid #e9ecef;
        }
        
        .preview-table tr:hover {
            background: #f8f9fa;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .checkbox-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Excel Data Importer for Smartways</h1>
            <p>Import your delivery data into Supabase database</p>
        </div>
        
        <div class="content">
            <!-- Step 1: Database Configuration -->
            <div class="section">
                <h2>
                    <span style="background: #2196F3; color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px;">1</span>
                    Database Configuration
                </h2>
                <div class="config-form">
                    <div class="form-group">
                        <label for="supabaseUrl">Supabase Project URL</label>
                        <input type="text" id="supabaseUrl" placeholder="https://YOUR_PROJECT.supabase.co">
                    </div>
                    <div class="form-group">
                        <label for="supabaseKey">Supabase Anon Key</label>
                        <input type="password" id="supabaseKey" placeholder="your-anon-public-key-here">
                    </div>
                    <button class="btn btn-primary" onclick="testConnection()">
                        üîå Test Connection
                    </button>
                </div>
                <div id="connectionStatus" style="display: none;"></div>
            </div>
            
            <!-- Step 2: File Upload -->
            <div class="section">
                <h2>
                    <span style="background: #2196F3; color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px;">2</span>
                    Upload Excel File
                </h2>
                <div class="file-input-wrapper" id="fileDropZone">
                    <p style="margin-bottom: 15px; font-size: 18px;">üìÅ Select or drag your Excel file here</p>
                    <button class="btn btn-primary" onclick="document.getElementById('excelFile').click()">
                        Choose Excel File
                    </button>
                    <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(this.files[0])">
                    <div id="fileInfo" style="margin-top: 15px; color: #666;"></div>
                </div>
                
                <!-- Data Preview -->
                <div id="dataPreview" style="display: none; margin-top: 20px;">
                    <h3 style="margin-bottom: 10px;">üìã Data Preview (First 5 rows)</h3>
                    <div style="overflow-x: auto;">
                        <table class="preview-table" id="previewTable">
                            <!-- Preview data will be inserted here -->
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Import Options -->
            <div class="section">
                <h2>
                    <span style="background: #2196F3; color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px;">3</span>
                    Import Data
                </h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="totalRows">0</div>
                        <div class="stat-label">Total Rows</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="uniqueBranches">0</div>
                        <div class="stat-label">Branches</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="uniquePickups">0</div>
                        <div class="stat-label">Pickup Locations</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="uniqueDeliveries">0</div>
                        <div class="stat-label">Delivery Locations</div>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="importBranchesCheck" checked>
                        Import Branches
                    </label>
                    <label>
                        <input type="checkbox" id="importPickupsCheck" checked>
                        Import Pickup Locations
                    </label>
                    <label>
                        <input type="checkbox" id="importDeliveriesCheck" checked>
                        Import Delivery Locations
                    </label>
                    <label>
                        <input type="checkbox" id="importDriversCheck">
                        Import Drivers (from Driver column)
                    </label>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-warning" onclick="importAll()" id="btnImportAll" disabled>
                        üöÄ Import Selected Data
                    </button>
                    <button class="btn btn-danger" onclick="clearDatabase()" id="btnClear" disabled>
                        üóëÔ∏è Clear Database First
                    </button>
                    <button class="btn btn-success" onclick="downloadSampleData()" title="Download sample CSV templates">
                        üì• Download Templates
                    </button>
                </div>
                
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                    </div>
                    <div id="progressText" style="text-align: center; margin-top: 10px; font-size: 14px; color: #666;"></div>
                </div>
                
                <div id="importStatus" style="display: none;"></div>
            </div>
            
            <!-- Import Log -->
            <div class="section">
                <h2>
                    <span style="background: #2196F3; color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px;">4</span>
                    Import Log
                </h2>
                <div class="log-area" id="logArea">
[System] Excel Data Importer initialized
[System] Ready to connect to Supabase...
                </div>
                <button class="btn btn-primary" onclick="clearLog()" style="margin-top: 10px;">
                    üßπ Clear Log
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Global variables
        let supabase = null;
        let excelData = [];
        let uniqueData = {
            branches: new Set(),
            pickups: new Set(),
            deliveries: new Set(),
            drivers: new Set(),
            states: new Set()
        };
        
        // File drag and drop
        const dropZone = document.getElementById('fileDropZone');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#1976D2';
            dropZone.style.background = '#e3f2fd';
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#2196F3';
            dropZone.style.background = '#f0f8ff';
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#2196F3';
            dropZone.style.background = '#f0f8ff';
            
            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                handleFileSelect(file);
            } else {
                alert('Please drop an Excel file (.xlsx or .xls)');
            }
        });
        
        // Database connection
        async function testConnection() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            if (!url || !key) {
                showStatus('connectionStatus', '‚ö†Ô∏è Please enter both URL and Key', 'error');
                return;
            }
            
            try {
                logMessage('[Database] Testing connection...');
                supabase = window.supabase.createClient(url, key);
                
                // Test connection by counting branches
                const { count, error } = await supabase
                    .from('branches')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    showStatus('connectionStatus', `‚ùå Connection failed: ${error.message}`, 'error');
                    logMessage(`[Error] ${error.message}`, 'error');
                } else {
                    showStatus('connectionStatus', `‚úÖ Connected successfully! Found ${count || 0} existing branches.`, 'success');
                    logMessage(`[Database] Connected successfully. ${count || 0} branches in database.`);
                    enableImportButtons();
                    
                    // Save credentials to localStorage for convenience
                    localStorage.setItem('supabaseUrl', url);
                    localStorage.setItem('supabaseKey', key);
                }
            } catch (error) {
                showStatus('connectionStatus', `‚ùå Error: ${error.message}`, 'error');
                logMessage(`[Error] ${error.message}`, 'error');
            }
        }
        
        // File handling
        function handleFileSelect(file) {
            if (!file) return;
            
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `<strong>Selected:</strong> ${file.name} (${formatFileSize(file.size)})`;
            
            dropZone.classList.add('has-file');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    logMessage(`[File] Reading ${file.name}...`);
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    excelData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (excelData.length === 0) {
                        throw new Error('No data found in Excel file');
                    }
                    
                    analyzeData();
                    showDataPreview();
                    logMessage(`[File] Successfully loaded ${excelData.length} rows`);
                    enableImportButtons();
                    
                } catch (error) {
                    logMessage(`[Error] Failed to read file: ${error.message}`, 'error');
                    fileInfo.innerHTML = `<span style="color: #f44336;">Error: ${error.message}</span>`;
                    dropZone.classList.remove('has-file');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Analyze Excel data
        function analyzeData() {
            uniqueData = {
                branches: new Set(),
                pickups: new Set(),
                deliveries: new Set(),
                drivers: new Set(),
                states: new Set()
            };
            
            excelData.forEach(row => {
                if (row['Branch']) uniqueData.branches.add(row['Branch'].toString().trim());
                if (row['Pickup Location']) uniqueData.pickups.add(row['Pickup Location'].toString().trim());
                if (row['Delivery Location']) uniqueData.deliveries.add(row['Delivery Location'].toString().trim());
                if (row['Driver Delivered']) uniqueData.drivers.add(row['Driver Delivered'].toString().trim());
                if (row['Delivery State']) uniqueData.states.add(row['Delivery State'].toString().trim());
            });
            
            // Update statistics
            document.getElementById('totalRows').textContent = excelData.length.toLocaleString();
            document.getElementById('uniqueBranches').textContent = uniqueData.branches.size.toLocaleString();
            document.getElementById('uniquePickups').textContent = uniqueData.pickups.size.toLocaleString();
            document.getElementById('uniqueDeliveries').textContent = uniqueData.deliveries.size.toLocaleString();
            
            logMessage('[Analysis] Data analysis complete:');
            logMessage(`  ‚Ä¢ ${uniqueData.branches.size} unique branches`);
            logMessage(`  ‚Ä¢ ${uniqueData.pickups.size} unique pickup locations`);
            logMessage(`  ‚Ä¢ ${uniqueData.deliveries.size} unique delivery locations`);
            logMessage(`  ‚Ä¢ ${uniqueData.drivers.size} unique drivers`);
            logMessage(`  ‚Ä¢ ${uniqueData.states.size} states`);
        }
        
        // Show data preview
        function showDataPreview() {
            const previewDiv = document.getElementById('dataPreview');
            const previewTable = document.getElementById('previewTable');
            
            if (excelData.length > 0) {
                const headers = Object.keys(excelData[0]);
                const previewRows = excelData.slice(0, 5);
                
                let tableHTML = '<thead><tr>';
                headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                previewRows.forEach(row => {
                    tableHTML += '<tr>';
                    headers.forEach(header => {
                        const value = row[header] || '';
                        const displayValue = value.toString().length > 30 ? 
                            value.toString().substring(0, 30) + '...' : value;
                        tableHTML += `<td>${displayValue}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                tableHTML += '</tbody>';
                
                previewTable.innerHTML = tableHTML;
                previewDiv.style.display = 'block';
            }
        }
        
        // Import all selected data
        async function importAll() {
            if (!supabase || excelData.length === 0) {
                alert('Please connect to database and load Excel file first');
                return;
            }
            
            const importBranches = document.getElementById('importBranchesCheck').checked;
            const importPickups = document.getElementById('importPickupsCheck').checked;
            const importDeliveries = document.getElementById('importDeliveriesCheck').checked;
            const importDrivers = document.getElementById('importDriversCheck').checked;
            
            if (!importBranches && !importPickups && !importDeliveries && !importDrivers) {
                alert('Please select at least one data type to import');
                return;
            }
            
            disableAllButtons();
            showProgress(true);
            
            logMessage('[Import] Starting import process...');
            let totalSteps = 0;
            let completedSteps = 0;
            
            // Calculate total steps
            if (importBranches) totalSteps++;
            if (importPickups) totalSteps++;
            if (importDeliveries) totalSteps++;
            if (importDrivers) totalSteps++;
            
            try {
                // Import branches
                if (importBranches) {
                    await importBranchData();
                    completedSteps++;
                    updateProgress(completedSteps, totalSteps, 'Branches imported');
                }
                
                // Import pickup locations
                if (importPickups) {
                    await importPickupData();
                    completedSteps++;
                    updateProgress(completedSteps, totalSteps, 'Pickup locations imported');
                }
                
                // Import delivery locations
                if (importDeliveries) {
                    await importDeliveryData();
                    completedSteps++;
                    updateProgress(completedSteps, totalSteps, 'Delivery locations imported');
                }
                
                // Import drivers
                if (importDrivers) {
                    await importDriverData();
                    completedSteps++;
                    updateProgress(completedSteps, totalSteps, 'Drivers imported');
                }
                
                showStatus('importStatus', 'üéâ All selected data imported successfully!', 'success');
                logMessage('[Import] ‚úÖ Import process completed successfully!');
                
            } catch (error) {
                showStatus('importStatus', `‚ùå Import failed: ${error.message}`, 'error');
                logMessage(`[Error] Import failed: ${error.message}`, 'error');
            } finally {
                showProgress(false);
                enableAllButtons();
            }
        }
        
        // Import branches
        async function importBranchData() {
            const branches = Array.from(uniqueData.branches).map(name => ({ name }));
            logMessage(`[Import] Importing ${branches.length} branches...`);
            
            const batchSize = 100;
            let imported = 0;
            
            for (let i = 0; i < branches.length; i += batchSize) {
                const batch = branches.slice(i, i + batchSize);
                
                const { data, error } = await supabase
                    .from('branches')
                    .upsert(batch, { onConflict: 'name' });
                
                if (error) throw error;
                
                imported += batch.length;
                logMessage(`  ‚Ä¢ Imported ${imported}/${branches.length} branches`);
            }
            
            return imported;
        }
        
        // Import pickup locations
        async function importPickupData() {
            // Get branch mappings first
            const { data: branchData } = await supabase
                .from('branches')
                .select('id, name');
            
            const branchMap = {};
            branchData?.forEach(b => branchMap[b.name] = b.id);
            
            const pickups = Array.from(uniqueData.pickups).map(name => {
                // Find associated branch from first occurrence in data
                const row = excelData.find(r => r['Pickup Location'] === name);
                const branchId = row && row['Branch'] ? branchMap[row['Branch'].toString().trim()] : null;
                
                return { name, branch_id: branchId };
            });
            
            logMessage(`[Import] Importing ${pickups.length} pickup locations...`);
            
            const batchSize = 100;
            let imported = 0;
            
            for (let i = 0; i < pickups.length; i += batchSize) {
                const batch = pickups.slice(i, i + batchSize);
                
                const { data, error } = await supabase
                    .from('pickup_locations')
                    .upsert(batch, { onConflict: 'name' });
                
                if (error) throw error;
                
                imported += batch.length;
                logMessage(`  ‚Ä¢ Imported ${imported}/${pickups.length} pickup locations`);
            }
            
            return imported;
        }
        
        // Import delivery locations
        async function importDeliveryData() {
            // Get branch mappings
            const { data: branchData } = await supabase
                .from('branches')
                .select('id, name');
            
            const branchMap = {};
            branchData?.forEach(b => branchMap[b.name] = b.id);
            
            const deliveries = Array.from(uniqueData.deliveries).map(name => {
                // Find associated branch and state from first occurrence
                const row = excelData.find(r => r['Delivery Location'] === name);
                const branchId = row && row['Branch'] ? branchMap[row['Branch'].toString().trim()] : null;
                const state = row && row['Delivery State'] ? row['Delivery State'].toString().trim() : null;
                
                return { name, state, branch_id: branchId };
            });
            
            logMessage(`[Import] Importing ${deliveries.length} delivery locations...`);
            
            const batchSize = 100;
            let imported = 0;
            
            for (let i = 0; i < deliveries.length; i += batchSize) {
                const batch = deliveries.slice(i, i + batchSize);
                
                const { data, error } = await supabase
                    .from('delivery_locations')
                    .upsert(batch, { onConflict: 'name' });
                
                if (error) throw error;
                
                imported += batch.length;
                logMessage(`  ‚Ä¢ Imported ${imported}/${deliveries.length} delivery locations`);
            }
            
            return imported;
        }
        
        // Import drivers
        async function importDriverData() {
            const drivers = Array.from(uniqueData.drivers).map(driverName => {
                // Extract region from driver name if present (e.g., "NSW Theo" -> region: NSW)
                const parts = driverName.split(' ');
                let region = null;
                let username = driverName;
                
                // Check if first part is a state code
                const stateCodes = ['NSW', 'VIC', 'QLD', 'WA', 'SA', 'TAS', 'ACT', 'NT'];
                if (parts.length > 1 && stateCodes.includes(parts[0])) {
                    region = parts[0];
                    username = parts.slice(1).join(' ');
                }
                
                return {
                    username: driverName,
                    full_name: username,
                    region: region
                };
            });
            
            logMessage(`[Import] Importing ${drivers.length} drivers...`);
            
            const batchSize = 100;
            let imported = 0;
            
            for (let i = 0; i < drivers.length; i += batchSize) {
                const batch = drivers.slice(i, i + batchSize);
                
                const { data, error } = await supabase
                    .from('drivers')
                    .upsert(batch, { onConflict: 'username' });
                
                if (error) throw error;
                
                imported += batch.length;
                logMessage(`  ‚Ä¢ Imported ${imported}/${drivers.length} drivers`);
            }
            
            return imported;
        }
        
        // Clear database
        async function clearDatabase() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL data from the database. Are you sure?')) {
                return;
            }
            
            disableAllButtons();
            logMessage('[Database] Clearing database...');
            
            try {
                // Delete in order to respect foreign key constraints
                await supabase.from('media_uploads').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('delivery_instructions').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('delivery_locations').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('pickup_locations').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('drivers').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                await supabase.from('branches').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                
                logMessage('[Database] ‚úÖ Database cleared successfully');
                showStatus('importStatus', '‚úÖ Database cleared', 'success');
            } catch (error) {
                logMessage(`[Error] Failed to clear database: ${error.message}`, 'error');
                showStatus('importStatus', `‚ùå Error: ${error.message}`, 'error');
            } finally {
                enableAllButtons();
            }
        }
        
        // Download sample data templates
        function downloadSampleData() {
            const csvContent = `Branch,Pickup Location,Delivery Location,Delivery State,Driver Delivered
SAMPLE BRANCH 1,SMARTWAYS WAREHOUSE,CUSTOMER SITE A,NSW,NSW John
SAMPLE BRANCH 2,DISTRIBUTION CENTER,CUSTOMER SITE B,VIC,VIC Sarah`;
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'smartways_import_template.csv';
            link.click();
            
            logMessage('[Download] Template CSV downloaded');
        }
        
        // UI Helper Functions
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.innerHTML = message;
            element.style.display = 'block';
        }
        
        function logMessage(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : '';
            logArea.innerHTML += `\n[${timestamp}] ${icon} ${message}`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logArea').innerHTML = '[System] Log cleared\n[System] Ready...';
        }
        
        function showProgress(show) {
            document.getElementById('progressContainer').style.display = show ? 'block' : 'none';
            if (!show) {
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('progressFill').textContent = '0%';
            }
        }
        
        function updateProgress(current, total, message = '') {
            const percentage = Math.round((current / total) * 100);
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            
            fill.style.width = percentage + '%';
            fill.textContent = percentage + '%';
            text.textContent = message;
        }
        
        function enableImportButtons() {
            if (supabase && excelData.length > 0) {
                document.getElementById('btnImportAll').disabled = false;
                document.getElementById('btnClear').disabled = false;
            }
        }
        
        function enableAllButtons() {
            document.querySelectorAll('button').forEach(btn => {
                if (btn.id === 'btnImportAll' || btn.id === 'btnClear') {
                    btn.disabled = !(supabase && excelData.length > 0);
                } else {
                    btn.disabled = false;
                }
            });
        }
        
        function disableAllButtons() {
            document.querySelectorAll('button').forEach(btn => btn.disabled = true);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved credentials if available
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');
            
            if (savedUrl) document.getElementById('supabaseUrl').value = savedUrl;
            if (savedKey) document.getElementById('supabaseKey').value = savedKey;
            
            logMessage('[System] Ready to import data');
            logMessage('[Info] Follow the steps above to import your Excel data');
        });
    </script>
</body>
</html>
